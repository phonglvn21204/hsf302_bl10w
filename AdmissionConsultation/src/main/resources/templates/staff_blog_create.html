<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<meta charset="UTF-8">
	<title>Viáº¿t blog má»›i</title>
	<link rel="stylesheet" th:href="@{/css/staff.css}">
	<script src="https://cdn.tiny.cloud/1/1vd6u8cixsilt5z7eywpghd45413duf2ojt4zszqw67dbdy4/tinymce/6/tinymce.min.js"
	        referrerpolicy="origin"></script>
	<script>
        tinymce.init({
            selector: '#content',
            height: 600,
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist checklist | outdent indent | link image media table | emoticons charmap | removeformat | preview code fullscreen help',
            menubar: 'file edit view insert format tools table help',
            images_upload_handler: function (blobInfo, success, failure) {
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                fetch('/staff/blogs/upload-image', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Server tráº£ lá»—i " + res.status);
                        return res.json();
                    })
                    .then(data => {
                        if (!data || typeof data.location !== 'string') {
                            throw new Error("Pháº£n há»“i khÃ´ng há»£p lá»‡: " + JSON.stringify(data));
                        }

                        const imageUrl = window.location.origin + data.location;
                        console.log("âœ… Upload thÃ nh cÃ´ng:", imageUrl);

                        success(imageUrl); // truyá»n Ä‘Ãºng URL cho TinyMCE
                    })
                    .catch(err => {
                        console.error("âŒ Upload lá»—i:", err);
                        failure("Upload áº£nh tháº¥t báº¡i: " + err.message);
                    });
            }
        });

        // Kiá»ƒm tra ná»™i dung trÆ°á»›c khi submit
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector("form").addEventListener("submit", function (e) {
                const editorContent = tinymce.get("content").getContent({ format: "text" }).trim();
                if (!editorContent) {
                    e.preventDefault();
                    alert("Vui lÃ²ng nháº­p ná»™i dung bÃ i viáº¿t.");
                    tinymce.get("content").focus();
                }
            });
        });
	</script>
</head>
<body>
<div class="staff-container">
	<div th:replace="fragments/sidebar_staff :: staffSidebar"></div>

	<div class="main-content">
		<h2>ğŸ“ Viáº¿t bÃ i blog má»›i</h2>

		<form th:action="@{/staff/blogs/create}" method="post" enctype="multipart/form-data" class="form-create-blog">
			<label for="title">TiÃªu Ä‘á» bÃ i viáº¿t:</label>
			<input type="text" id="title" name="title" th:value="${blogPost.title}" required>

			<label for="imageFile">áº¢nh Ä‘áº¡i diá»‡n:</label>
			<input type="file" id="imageFile" name="imageFile" accept="image/*">

			<label for="content">Ná»™i dung bÃ i viáº¿t:</label>
			<!-- âŒ KhÃ´ng thÃªm `required` vÃ o Ä‘Ã¢y vÃ¬ TinyMCE sáº½ áº©n nÃ³ -->
			<textarea id="content" name="content" rows="10" th:text="${blogPost.content}"></textarea>

			<label for="status">Tráº¡ng thÃ¡i:</label>
			<select id="status" name="status">
				<option value="draft" th:selected="${blogPost.status == 'draft'}">Draft</option>
				<option value="hidden" th:selected="${blogPost.status == 'hidden'}">Hidden</option>
				<option value="published" th:selected="${blogPost.status == 'published'}">Published</option>
			</select>

			<button type="submit">ğŸ“¤ ÄÄƒng bÃ i</button>
		</form>
	</div>
</div>
</body>
</html>
